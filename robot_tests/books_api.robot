*** Settings ***
Documentation     Books Service API Test Suite
...
...               This test suite validates the Books Service REST API functionality
...               including CRUD operations, search, validation, and error handling.
...
...               Test Strategy:
...               - Read-focused with minimal data creation
...               - Database is read-only (existing data used)
...               - Uses Gherkin syntax (Given/When/Then)
...               - Independent test execution
...               - Comprehensive response validation
...
...               Source: Generated by Claude Code following RF 7.4.1 standards
...               Version: robotframework==7.4.1, robotframework-requests==0.9.7

Resource          resources/common.resource
Resource          resources/api/BooksAPI.resource

Suite Setup       Initialize API Test Suite
Suite Teardown    Cleanup API Test Suite
Test Setup        Setup Individual API Test
Test Teardown     Teardown Individual API Test

Force Tags        api    books    rest
Default Tags      smoke


*** Variables ***
${NONEXISTENT_BOOK_ID}    999999
${INVALID_BOOK_ID}        invalid_id


*** Test Cases ***
API Should Return All Books Successfully
    [Documentation]    Verify GET /books/ returns complete books list
    ...
    ...                Steps:
    ...                1. Send GET request to /books/ endpoint
    ...                2. Verify response status is 200 OK
    ...                3. Verify response contains books list
    ...                4. Verify list is not empty
    ...
    ...                Expected: API returns successful response with books data
    [Tags]    get    list    positive    priority-high

    Given API Session Is Initialized
    When User Requests All Books From API
    Then Response Status Should Be Success
    And Response Should Contain Books List
    And Books List Should Not Be Empty

API Should Return Specific Book By ID
    [Documentation]    Verify GET /books/{id} returns correct book details
    ...
    ...                Steps:
    ...                1. Get list of all books
    ...                2. Extract first book ID
    ...                3. Request specific book by ID
    ...                4. Verify book details match
    ...
    ...                Expected: API returns correct book with all fields
    [Tags]    get    detail    positive    priority-high

    Given API Session Is Initialized
    And A Valid Book ID Is Available
    When User Requests Book By ID
    Then Response Status Should Be Success
    And Response Should Contain Book Details
    And Book Details Should Have Required Fields

API Should Return Error For Nonexistent Book ID
    [Documentation]    Verify GET /books/{id} handles invalid ID gracefully
    ...
    ...                Steps:
    ...                1. Send GET request with nonexistent book ID
    ...                2. Verify response status is 404 Not Found
    ...
    ...                Expected: API returns 404 error for nonexistent book
    [Tags]    get    error    negative    priority-high

    Given API Session Is Initialized
    When User Requests Nonexistent Book    ${NONEXISTENT_BOOK_ID}
    Then Response Status Should Be Not Found

API Should Create New Book Successfully
    [Documentation]    Verify POST /books/ creates new book
    ...
    ...                Steps:
    ...                1. Prepare unique book data
    ...                2. Send POST request to create book
    ...                3. Verify response status is 201 Created
    ...                4. Verify created book has ID
    ...                5. Verify book data matches request
    ...
    ...                Expected: API creates book and returns complete details
    [Tags]    post    create    positive    priority-high

    Given API Session Is Initialized
    And Unique Test Book Data Is Prepared
    When User Creates New Book Via API
    Then Response Status Should Be Created
    And Response Should Contain Book ID
    And Created Book Data Should Match Request

API Should Validate Required Fields On Create
    [Documentation]    Verify POST /books/ validates required fields
    ...
    ...                Steps:
    ...                1. Send POST request with missing required field (title)
    ...                2. Verify response status is 400 Bad Request
    ...
    ...                Expected: API rejects invalid request with 400 error
    [Tags]    post    validation    negative    priority-medium

    Given API Session Is Initialized
    When User Attempts To Create Book With Missing Title
    Then Response Status Should Be Bad Request

API Should Update Existing Book Successfully
    [Documentation]    Verify PUT /books/{id} updates book data
    ...
    ...                Steps:
    ...                1. Create test book
    ...                2. Update book with new data
    ...                3. Verify response status is 200 OK
    ...                4. Verify updated data matches request
    ...
    ...                Expected: API updates book successfully
    [Tags]    put    update    positive    priority-high

    Given API Session Is Initialized
    And A Test Book Is Created
    When User Updates Book With New Data
    Then Response Status Should Be Success
    And Updated Book Data Should Match Request

API Should Handle Update Of Nonexistent Book
    [Documentation]    Verify PUT /books/{id} handles invalid ID
    ...
    ...                Steps:
    ...                1. Attempt to update nonexistent book
    ...                2. Verify response status is 404 Not Found
    ...
    ...                Expected: API returns 404 for nonexistent book
    [Tags]    put    error    negative    priority-medium

    Given API Session Is Initialized
    When User Attempts To Update Nonexistent Book    ${NONEXISTENT_BOOK_ID}
    Then Response Status Should Be Not Found

API Should Delete Book Successfully
    [Documentation]    Verify DELETE /books/{id} removes book
    ...
    ...                Steps:
    ...                1. Create test book
    ...                2. Delete the book
    ...                3. Verify response status is 204 No Content
    ...                4. Verify book no longer exists
    ...
    ...                Expected: API deletes book successfully
    [Tags]    delete    positive    priority-high

    Given API Session Is Initialized
    And A Test Book Is Created
    When User Deletes The Book
    Then Response Status Should Be No Content
    And Book Should No Longer Exist

API Should Handle Delete Of Nonexistent Book
    [Documentation]    Verify DELETE /books/{id} handles invalid ID
    ...
    ...                Steps:
    ...                1. Attempt to delete nonexistent book
    ...                2. Verify response status is 404 Not Found
    ...
    ...                Expected: API returns 404 for nonexistent book
    [Tags]    delete    error    negative    priority-medium

    Given API Session Is Initialized
    When User Attempts To Delete Nonexistent Book    ${NONEXISTENT_BOOK_ID}
    Then Response Status Should Be Not Found

API Should Support Partial Book Update
    [Documentation]    Verify PATCH /books/{id} is not supported (returns 405)
    ...
    ...                Steps:
    ...                1. Create test book
    ...                2. Attempt PATCH request
    ...                3. Verify response status is 405 Method Not Allowed
    ...
    ...                Expected: API returns 405 (PATCH not implemented)
    [Tags]    patch    update    negative    priority-low

    Given API Session Is Initialized
    And A Test Book Is Created
    When User Attempts Partial Update
    Then Response Status Should Be Method Not Allowed

API Should Return Books List With Minimum Count
    [Documentation]    Verify API returns sufficient sample data
    ...
    ...                Validates that sample data initialization worked correctly
    ...                by confirming minimum book count threshold is met.
    ...
    ...                Expected: At least 50 books in database
    [Tags]    get    list    data-validation    priority-low

    Given API Session Is Initialized
    When User Requests All Books From API
    Then Response Status Should Be Success
    And Books List Should Have Minimum Books    50

API Should Support Complete CRUD Lifecycle
    [Documentation]    Verify complete Create-Read-Update-Delete workflow
    ...
    ...                This integration test validates full CRUD cycle:
    ...                1. Create new book
    ...                2. Read created book
    ...                3. Update book data
    ...                4. Read updated book
    ...                5. Delete book
    ...                6. Verify deletion
    ...
    ...                Expected: All CRUD operations work seamlessly
    [Tags]    crud    integration    positive    priority-high

    Given API Session Is Initialized
    When User Performs Complete CRUD Cycle
    Then All CRUD Operations Should Succeed


*** Keywords ***
# Given Keywords (Preconditions)
Given API Session Is Initialized
    [Documentation]    Precondition: API session is ready

    Ensure API Session Exists

Given A Valid Book ID Is Available
    [Documentation]    Precondition: Obtain valid book ID from existing data

    ${response}=    Get All Books
    ${books}=       Set Variable    ${response.json()}
    ${first_book}=  Set Variable    ${books}[0]
    ${book_id}=     Set Variable    ${first_book}[id]

    Set Test Variable    ${VALID_BOOK_ID}    ${book_id}
    Log    Using book ID: ${book_id}

Given Unique Test Book Data Is Prepared
    [Documentation]    Precondition: Generate unique book data

    &{book_data}=    Create Unique Test Book Data
    Set Test Variable    ${TEST_BOOK_DATA}    ${book_data}

    Log    Prepared test book data: ${book_data}

Given A Test Book Is Created
    [Documentation]    Precondition: Create test book for update/delete tests

    &{book_data}=    Create Unique Test Book Data
    ${response}=    Create Book With Data    &{book_data}
    ${created_id}=    Extract Book ID From Response    ${response}

    Set Test Variable    ${TEST_BOOK_ID}      ${created_id}
    Set Test Variable    ${TEST_BOOK_DATA}    ${book_data}

    Log    Created test book with ID: ${created_id}

# When Keywords (Actions)
When User Requests All Books From API
    [Documentation]    Action: Send GET request for all books

    ${response}=    Get All Books
    Set Test Variable    ${API_RESPONSE}    ${response}

When User Requests Book By ID
    [Documentation]    Action: Send GET request for specific book

    ${response}=    Get Book By ID    ${VALID_BOOK_ID}
    Set Test Variable    ${API_RESPONSE}    ${response}

When User Requests Nonexistent Book
    [Documentation]    Action: Request book with invalid ID
    [Arguments]    ${book_id}

    ${response}=    Get Book By ID Expecting Error    ${book_id}    expected_status=${HTTP_NOT_FOUND}
    Set Test Variable    ${API_RESPONSE}    ${response}

When User Creates New Book Via API
    [Documentation]    Action: Send POST request to create book

    ${response}=    Create Book With Data    &{TEST_BOOK_DATA}
    Set Test Variable    ${API_RESPONSE}    ${response}

    ${created_id}=    Extract Book ID From Response    ${response}
    Set Test Variable    ${CREATED_BOOK_ID}    ${created_id}

When User Attempts To Create Book With Missing Title
    [Documentation]    Action: Attempt invalid POST request

    VAR    &{invalid_data}    author=Test Author    pages=${200}
    ${response}=    Create Book Expecting Error    &{invalid_data}
    Set Test Variable    ${API_RESPONSE}    ${response}

When User Updates Book With New Data
    [Documentation]    Action: Send PUT request to update book

    ${unique_id}=    Generate Unique Test Data    prefix=UPD_
    ${new_title}=    Catenate    Updated Book    ${unique_id}
    ${new_author}=     Catenate    Updated Author    ${unique_id}

    ${response}=    Update Book    ${TEST_BOOK_ID}    ${new_title}    ${new_author}    ${300}    UpdatedCategory
    Set Test Variable    ${API_RESPONSE}      ${response}
    Set Test Variable    ${UPDATED_TITLE}     ${new_title}
    Set Test Variable    ${UPDATED_AUTHOR}    ${new_author}

When User Attempts To Update Nonexistent Book
    [Documentation]    Action: Attempt to update invalid book
    [Arguments]    ${book_id}

    VAR    &{book_data}    title=Any    author=Any    isbn=Any    year=${2024}

    TRY
        ${response}=    Update Book With Data    ${book_id}    &{book_data}
        Fail    Expected 404 error but request succeeded
    EXCEPT    AS    ${error}
        # Expected to fail, catch and verify via DELETE endpoint
        ${response}=    Delete Book Expecting Error    ${book_id}    expected_status=${HTTP_NOT_FOUND}
        Set Test Variable    ${API_RESPONSE}    ${response}
    END

When User Deletes The Book
    [Documentation]    Action: Send DELETE request

    ${response}=    Delete Book    ${TEST_BOOK_ID}
    Set Test Variable    ${API_RESPONSE}    ${response}

When User Attempts To Delete Nonexistent Book
    [Documentation]    Action: Attempt to delete invalid book
    [Arguments]    ${book_id}

    ${response}=    Delete Book Expecting Error    ${book_id}    expected_status=${HTTP_NOT_FOUND}
    Set Test Variable    ${API_RESPONSE}    ${response}

When User Partially Updates Book Title
    [Documentation]    Action: Send PATCH request for partial update

    ${unique_id}=    Generate Unique Test Data    prefix=PATCH_
    ${new_title}=    Catenate    Patched Title    ${unique_id}

    VAR    &{fields}       title=${new_title}
    ${response}=    Partial Update Book    ${TEST_BOOK_ID}    &{fields}

    Set Test Variable    ${API_RESPONSE}    ${response}
    Set Test Variable    ${PATCHED_TITLE}   ${new_title}

When User Attempts Partial Update
    [Documentation]    Action: Attempt PATCH request (expects 405)

    VAR    &{fields}       title=Test Update
    TRY
        ${response}=    PATCH On Session    books_api    /books/${TEST_BOOK_ID}
        ...            json=${fields}    expected_status=405
        Set Test Variable    ${API_RESPONSE}    ${response}
    EXCEPT
        Fail    PATCH request did not return expected 405 status
    END

When User Performs Complete CRUD Cycle
    [Documentation]    Action: Execute full CRUD workflow

    # CREATE
    &{book_data}=    Create Unique Test Book Data
    ${create_resp}=    Create Book With Data    &{book_data}
    ${book_id}=    Extract Book ID From Response    ${create_resp}

    # READ
    ${read_resp}=    Get Book By ID    ${book_id}

    # UPDATE
    ${new_title}=    Catenate    Updated    ${book_data}[title]
    ${update_resp}=    Update Book    ${book_id}    ${new_title}    ${book_data}[author]    ${book_data}[pages]    ${book_data}[category]

    # DELETE
    ${delete_resp}=    Delete Book    ${book_id}

    # VERIFY DELETE
    ${verify_resp}=    Get Book By ID Expecting Error    ${book_id}

    # Store results
    Set Test Variable    ${CRUD_CREATE_RESPONSE}    ${create_resp}
    Set Test Variable    ${CRUD_READ_RESPONSE}      ${read_resp}
    Set Test Variable    ${CRUD_UPDATE_RESPONSE}    ${update_resp}
    Set Test Variable    ${CRUD_DELETE_RESPONSE}    ${delete_resp}
    Set Test Variable    ${CRUD_VERIFY_RESPONSE}    ${verify_resp}

# Then Keywords (Verifications)
Then Response Status Should Be Success
    [Documentation]    Verification: Response has 200 OK status

    Verify Response Success    ${API_RESPONSE}    expected_status=${HTTP_OK}

Then Response Status Should Be Created
    [Documentation]    Verification: Response has 200 OK status (API returns 200 for creates)

    Verify Response Success    ${API_RESPONSE}    expected_status=${HTTP_OK}

Then Response Status Should Be No Content
    [Documentation]    Verification: Response has 200 OK status (API returns 200 for deletes)

    Verify Response Success    ${API_RESPONSE}    expected_status=${HTTP_OK}

Then Response Status Should Be Bad Request
    [Documentation]    Verification: Response has 422 Unprocessable Entity status (validation error)

    Verify Error Response    ${API_RESPONSE}    ${HTTP_UNPROCESSABLE_ENTITY}

Then Response Status Should Be Not Found
    [Documentation]    Verification: Response has 404 Not Found status

    Verify Error Response    ${API_RESPONSE}    ${HTTP_NOT_FOUND}

Then Response Status Should Be Method Not Allowed
    [Documentation]    Verification: Response has 405 Method Not Allowed status

    Should Be Equal As Integers    ${API_RESPONSE.status_code}    405
    ...    msg=Expected 405 Method Not Allowed

Then Response Should Contain Books List
    [Documentation]    Verification: Response body contains books array

    ${books}=    Set Variable    ${API_RESPONSE.json()}
    ${length}=    Get Length    ${books}
    Should Be True    ${length} >= 0    msg=Response is not a list

Then Books List Should Not Be Empty
    [Documentation]    Verification: Books list has at least one book

    Verify Books List Is Not Empty    ${API_RESPONSE}

Then Response Should Contain Book Details
    [Documentation]    Verification: Response contains single book object

    ${book}=    Set Variable    ${API_RESPONSE.json()}
    Should Not Be Equal    ${book}    ${None}

Then Book Details Should Have Required Fields
    [Documentation]    Verification: Book has all mandatory fields

    Verify Book Response Contains Required Fields    ${API_RESPONSE}

Then Response Should Contain Book ID
    [Documentation]    Verification: Response includes book ID

    Verify Book ID In Response    ${API_RESPONSE}

Then Created Book Data Should Match Request
    [Documentation]    Verification: Created book matches request data

    Verify Book Data Matches    ${API_RESPONSE}
    ...    ${TEST_BOOK_DATA}[title]
    ...    ${TEST_BOOK_DATA}[author]

Then Updated Book Data Should Match Request
    [Documentation]    Verification: Updated book reflects new data

    Verify Book Data Matches    ${API_RESPONSE}
    ...    ${UPDATED_TITLE}
    ...    ${UPDATED_AUTHOR}

Then Book Should No Longer Exist
    [Documentation]    Verification: Deleted book returns 404

    ${response}=    Get Book By ID Expecting Error    ${TEST_BOOK_ID}
    Should Be Equal As Integers    ${response.status_code}    ${HTTP_NOT_FOUND}

Then Only Updated Fields Should Change
    [Documentation]    Verification: PATCH only modifies specified fields

    ${book}=    Set Variable    ${API_RESPONSE.json()}

    # Verify patched field changed
    Should Be Equal As Strings    ${book}[title]    ${PATCHED_TITLE}

    # Verify other fields unchanged (match original)
    Should Be Equal As Strings    ${book}[author]    ${TEST_BOOK_DATA}[author]
    Should Be Equal As Integers    ${book}[pages]     ${TEST_BOOK_DATA}[pages]

Then Books List Should Have Minimum Books
    [Documentation]    Verification: List meets minimum count threshold
    [Arguments]    ${count}

    ${minimum}=    Convert To Integer    ${count}
    Verify Books List Contains Minimum Count    ${API_RESPONSE}    ${minimum}

Then All CRUD Operations Should Succeed
    [Documentation]    Verification: All CRUD steps completed successfully

    # Verify CREATE (200 - API returns 200 not 201)
    Should Be Equal As Integers    ${CRUD_CREATE_RESPONSE.status_code}    ${HTTP_OK}

    # Verify READ (200)
    Should Be Equal As Integers    ${CRUD_READ_RESPONSE.status_code}    ${HTTP_OK}

    # Verify UPDATE (200)
    Should Be Equal As Integers    ${CRUD_UPDATE_RESPONSE.status_code}    ${HTTP_OK}

    # Verify DELETE (200 - API returns 200 not 204)
    Should Be Equal As Integers    ${CRUD_DELETE_RESPONSE.status_code}    ${HTTP_OK}

    # Verify book deleted (404)
    Should Be Equal As Integers    ${CRUD_VERIFY_RESPONSE.status_code}    ${HTTP_NOT_FOUND}

    Log    Complete CRUD cycle verified successfully

# And Keywords (Additional Verifications)
And Response Should Contain Books List
    [Documentation]    Additional verification: Books list present

    Then Response Should Contain Books List

And Books List Should Not Be Empty
    [Documentation]    Additional verification: List has content

    Then Books List Should Not Be Empty

And Response Should Contain Book Details
    [Documentation]    Additional verification: Book details present

    Then Response Should Contain Book Details

And Book Details Should Have Required Fields
    [Documentation]    Additional verification: Required fields present

    Then Book Details Should Have Required Fields

And Response Should Contain Book ID
    [Documentation]    Additional verification: Book ID present

    Then Response Should Contain Book ID

And Created Book Data Should Match Request
    [Documentation]    Additional verification: Data matches

    Then Created Book Data Should Match Request

And Updated Book Data Should Match Request
    [Documentation]    Additional verification: Update successful

    Then Updated Book Data Should Match Request

And Book Should No Longer Exist
    [Documentation]    Additional verification: Deletion confirmed

    Then Book Should No Longer Exist

And Only Updated Fields Should Change
    [Documentation]    Additional verification: Partial update worked

    Then Only Updated Fields Should Change

And Books List Should Have Minimum Books
    [Documentation]    Additional verification: Count threshold met
    [Arguments]    ${count}

    Then Books List Should Have Minimum Books    ${count}

And All CRUD Operations Should Succeed
    [Documentation]    Additional verification: CRUD cycle complete

    Then All CRUD Operations Should Succeed

And A Valid Book ID Is Available
    [Documentation]    Additional precondition: Valid book ID available

    Given A Valid Book ID Is Available

And Unique Test Book Data Is Prepared
    [Documentation]    Additional precondition: Test data prepared

    Given Unique Test Book Data Is Prepared

And A Test Book Is Created
    [Documentation]    Additional precondition: Test book created

    Given A Test Book Is Created

# Suite Lifecycle Keywords
Initialize API Test Suite
    [Documentation]    Setup for entire API test suite

    Log    Starting API Test Suite: Books Service
    Initialize Test Environment
    Log    API Test Suite initialized successfully

Cleanup API Test Suite
    [Documentation]    Cleanup after entire API test suite

    Log    Cleaning up API Test Suite
    Cleanup Test Environment
    Log    API Test Suite cleanup completed

# Test Lifecycle Keywords
Setup Individual API Test
    [Documentation]    Setup for individual API test case

    Log    Starting API test: ${TEST_NAME}

Teardown Individual API Test
    [Documentation]    Cleanup after individual API test case
    ...                Cleans up any test data created during test

    IF    '${TEST_STATUS}' == 'FAIL'
        Log    API test failed: ${TEST_NAME}
    END

    # Cleanup test book if created
    TRY
        IF    '${CREATED_BOOK_ID}' != '${None}'
            Delete Book    ${CREATED_BOOK_ID}
            Log    Cleaned up test book: ${CREATED_BOOK_ID}
        END
    EXCEPT
        Log    No test book to cleanup    level=DEBUG
    END

    TRY
        IF    '${TEST_BOOK_ID}' != '${None}'
            Delete Book    ${TEST_BOOK_ID}
            Log    Cleaned up test book: ${TEST_BOOK_ID}
        END
    EXCEPT
        Log    Test book already cleaned or not created    level=DEBUG
    END

    Log    API test completed: ${TEST_NAME}
