*** Settings ***
Documentation     API Resource for Books Service
...
...               This resource file contains all keywords for Books REST API operations,
...               including CRUD operations, search, validation, and error handling.
...
...               Source: Generated by Claude Code following API testing best practices

Library           RequestsLibrary
Library           Collections
Library           String
Resource          ../common.resource


*** Variables ***
# API Endpoints
${BOOKS_LIST_ENDPOINT}      /books/
${BOOKS_DETAIL_ENDPOINT}    /books/{book_id}
${BOOKS_SEARCH_ENDPOINT}    /books/search

# Common Headers
${CONTENT_TYPE_JSON}        application/json
${ACCEPT_JSON}              application/json


*** Keywords ***
# Session Management
Ensure API Session Exists
    [Documentation]    Verify API session exists, create if needed

    TRY
        Create API Session
        Log    Created new API session
    EXCEPT
        Log    API session already exists    level=DEBUG
    END

# HTTP GET Operations
Get All Books
    [Documentation]    Retrieve all books from API
    ...                Returns: Response object with books list

    Ensure API Session Exists

    Log Request Details    GET    ${BOOKS_LIST_ENDPOINT}
    ${response}=    GET On Session    books_api    ${BOOKS_LIST_ENDPOINT}
    ...                    expected_status=${HTTP_OK}
    Log Response Details    ${response}

    RETURN    ${response}

Get Book By ID
    [Documentation]    Retrieve specific book by ID
    ...                Returns: Response object with book details
    [Arguments]    ${book_id}

    Ensure API Session Exists

    ${endpoint}=    Set Variable    /books/${book_id}
    Log Request Details    GET    ${endpoint}

    ${response}=    GET On Session    books_api    ${endpoint}
    ...                    expected_status=${HTTP_OK}
    Log Response Details    ${response}

    RETURN    ${response}

Get Book By ID Expecting Error
    [Documentation]    Attempt to get book with expected error response
    ...                Returns: Response object (may contain error)
    [Arguments]    ${book_id}    ${expected_status}=${HTTP_NOT_FOUND}

    Ensure API Session Exists

    ${endpoint}=    Set Variable    /books/${book_id}
    Log Request Details    GET    ${endpoint}

    ${response}=    GET On Session    books_api    ${endpoint}
    ...                    expected_status=${expected_status}
    Log Response Details    ${response}

    RETURN    ${response}

Search Books By Title
    [Documentation]    Search books by title parameter
    ...                Returns: Response object with matching books
    [Arguments]    ${title}

    Ensure API Session Exists

    VAR    &{params}      title=${title}
    ${response}=    GET On Session    books_api    ${BOOKS_LIST_ENDPOINT}
    ...                    params=${params}    expected_status=${HTTP_OK}

    Log    Searched books with title: ${title}
    RETURN    ${response}

Search Books By Author
    [Documentation]    Search books by author parameter
    ...                Returns: Response object with matching books
    [Arguments]    ${author}

    Ensure API Session Exists

    VAR    &{params}      author=${author}
    ${response}=    GET On Session    books_api    ${BOOKS_LIST_ENDPOINT}
    ...                    params=${params}    expected_status=${HTTP_OK}

    Log    Searched books with author: ${author}
    RETURN    ${response}

# HTTP POST Operations
Create Book
    [Documentation]    Create new book via API
    ...                Returns: Response object with created book
    [Arguments]    ${title}    ${author}    ${pages}=${250}    ${category}=Test

    Ensure API Session Exists

    VAR    &{book_data}    title=${title}    author=${author}    pages=${pages}    category=${category}

    Log Request Details    POST    ${BOOKS_LIST_ENDPOINT}    ${book_data}
    ${response}=    POST On Session    books_api    ${BOOKS_LIST_ENDPOINT}
    ...                    json=${book_data}    expected_status=${HTTP_OK}
    Log Response Details    ${response}

    Log    Created book: ${title}
    RETURN    ${response}

Create Book With Data
    [Documentation]    Create book using dictionary data
    ...                Returns: Response object with created book
    [Arguments]    &{book_data}

    Ensure API Session Exists

    Log Request Details    POST    ${BOOKS_LIST_ENDPOINT}    ${book_data}
    ${response}=    POST On Session    books_api    ${BOOKS_LIST_ENDPOINT}
    ...                    json=${book_data}    expected_status=${HTTP_OK}
    Log Response Details    ${response}

    RETURN    ${response}

Create Book Expecting Error
    [Documentation]    Attempt to create book expecting error response
    ...                Returns: Response object with error
    [Arguments]    &{book_data}

    Ensure API Session Exists

    ${expected}=    Set Variable    ${HTTP_UNPROCESSABLE_ENTITY}
    Log Request Details    POST    ${BOOKS_LIST_ENDPOINT}    ${book_data}

    ${response}=    POST On Session    books_api    ${BOOKS_LIST_ENDPOINT}
    ...                    json=${book_data}    expected_status=${expected}
    Log Response Details    ${response}

    RETURN    ${response}

# HTTP PUT Operations
Update Book
    [Documentation]    Update existing book via API
    ...                Returns: Response object with updated book
    [Arguments]    ${book_id}    ${title}    ${author}    ${pages}=${250}    ${category}=Test

    Ensure API Session Exists

    VAR    &{book_data}    title=${title}    author=${author}    pages=${pages}    category=${category}
    ${endpoint}=    Set Variable    /books/${book_id}

    Log Request Details    PUT    ${endpoint}    ${book_data}
    ${response}=    PUT On Session    books_api    ${endpoint}
    ...                    json=${book_data}    expected_status=${HTTP_OK}
    Log Response Details    ${response}

    Log    Updated book ID: ${book_id}
    RETURN    ${response}

Update Book With Data
    [Documentation]    Update book using dictionary data
    ...                Returns: Response object with updated book
    [Arguments]    ${book_id}    &{book_data}

    Ensure API Session Exists

    ${endpoint}=    Set Variable    /books/${book_id}
    Log Request Details    PUT    ${endpoint}    ${book_data}

    ${response}=    PUT On Session    books_api    ${endpoint}
    ...                    json=${book_data}    expected_status=${HTTP_OK}
    Log Response Details    ${response}

    RETURN    ${response}

# HTTP PATCH Operations (Partial Update)
Partial Update Book
    [Documentation]    Partially update book fields
    ...                Returns: Response object with updated book
    [Arguments]    ${book_id}    &{fields_to_update}

    Ensure API Session Exists

    ${endpoint}=    Set Variable    /books/${book_id}
    Log Request Details    PATCH    ${endpoint}    ${fields_to_update}

    ${response}=    PATCH On Session    books_api    ${endpoint}
    ...                    json=${fields_to_update}    expected_status=${HTTP_OK}
    Log Response Details    ${response}

    Log    Partially updated book ID: ${book_id}
    RETURN    ${response}

# HTTP DELETE Operations
Delete Book
    [Documentation]    Delete book by ID
    ...                Returns: Response object
    [Arguments]    ${book_id}

    Ensure API Session Exists

    ${endpoint}=    Set Variable    /books/${book_id}
    Log Request Details    DELETE    ${endpoint}

    ${response}=    DELETE On Session    books_api    ${endpoint}
    ...                    expected_status=${HTTP_OK}
    Log Response Details    ${response}

    Log    Deleted book ID: ${book_id}
    RETURN    ${response}

Delete Book Expecting Error
    [Documentation]    Attempt to delete book expecting error
    ...                Returns: Response object with error
    [Arguments]    ${book_id}    ${expected_status}=${HTTP_NOT_FOUND}

    Ensure API Session Exists

    ${endpoint}=    Set Variable    /books/${book_id}
    Log Request Details    DELETE    ${endpoint}

    ${response}=    DELETE On Session    books_api    ${endpoint}
    ...                    expected_status=${expected_status}
    Log Response Details    ${response}

    RETURN    ${response}

# Verification Keywords
Verify Book Response Contains Required Fields
    [Documentation]    Verify book response has all required fields
    [Arguments]    ${response}

    ${book}=    Set Variable    ${response.json()}

    Dictionary Should Contain Key    ${book}    id         msg=Book missing 'id' field
    Dictionary Should Contain Key    ${book}    title      msg=Book missing 'title' field
    Dictionary Should Contain Key    ${book}    author     msg=Book missing 'author' field
    Dictionary Should Contain Key    ${book}    pages      msg=Book missing 'pages' field

    Log    Book response contains all required fields

Verify Book Data Matches
    [Documentation]    Verify book data matches expected values
    [Arguments]    ${response}    ${expected_title}    ${expected_author}

    ${book}=    Set Variable    ${response.json()}

    Should Be Equal As Strings    ${book}[title]     ${expected_title}
    ...    msg=Title mismatch: expected '${expected_title}', got '${book}[title]'

    Should Be Equal As Strings    ${book}[author]    ${expected_author}
    ...    msg=Author mismatch: expected '${expected_author}', got '${book}[author]'

    Log    Book data verified successfully

Verify Books List Is Not Empty
    [Documentation]    Verify API response contains at least one book
    [Arguments]    ${response}

    ${books}=    Set Variable    ${response.json()}
    ${count}=    Get Length    ${books}

    Should Be True    ${count} > 0    msg=Books list is empty

Verify Books List Contains Minimum Count
    [Documentation]    Verify books list has minimum number of books
    [Arguments]    ${response}    ${minimum_count}

    ${books}=    Set Variable    ${response.json()}
    ${count}=    Get Length    ${books}

    Should Be True    ${count} >= ${minimum_count}
    ...    msg=Expected at least ${minimum_count} books, but got ${count}

Verify Error Response
    [Documentation]    Verify error response contains expected error message
    [Arguments]    ${response}    ${expected_status}

    Should Be Equal As Integers    ${response.status_code}    ${expected_status}
    ...    msg=Expected status ${expected_status}, got ${response.status_code}

Verify Book ID In Response
    [Documentation]    Verify response contains valid book ID
    [Arguments]    ${response}

    ${book}=    Set Variable    ${response.json()}
    Dictionary Should Contain Key    ${book}    id

    ${book_id}=    Set Variable    ${book}[id]
    Should Not Be Equal    ${book_id}    ${None}    msg=Book ID is None

    Log    Book ID: ${book_id}

# Helper Keywords
Extract Book ID From Response
    [Documentation]    Extract book ID from API response
    ...                Returns: Book ID as integer
    [Arguments]    ${response}

    ${book}=    Set Variable    ${response.json()}
    ${book_id}=    Set Variable    ${book}[id]

    Log    Extracted book ID: ${book_id}
    RETURN    ${book_id}

Extract Book Field From Response
    [Documentation]    Extract specific field from book response
    ...                Returns: Field value
    [Arguments]    ${response}    ${field_name}

    ${book}=    Set Variable    ${response.json()}
    ${value}=    Set Variable    ${book}[${field_name}]

    Log    Extracted ${field_name}: ${value}
    RETURN    ${value}

Create Unique Test Book Data
    [Documentation]    Generate unique book data for testing
    ...                Returns: Dictionary with unique book data

    ${unique_id}=    Generate Unique Test Data    prefix=BOOK_
    ${title}=    Catenate    Test Book    ${unique_id}
    ${author}=    Catenate    Test Author    ${unique_id}
    ${pages}=    Set Variable    ${250}
    ${category}=    Set Variable    Test

    VAR    &{book_data}    title=${title}    author=${author}    pages=${pages}    category=${category}

    Log    Created unique test book data
    RETURN    &{book_data}

Find Book In List By Title
    [Documentation]    Find specific book in books list by title
    ...                Returns: Book dictionary or None
    [Arguments]    ${books_list}    ${title}

    FOR    ${book}    IN    @{books_list}
        IF    '${book}[title]' == '${title}'
            Log    Found book: ${title}
            RETURN    ${book}
        END
    END

    Log    Book not found: ${title}
    RETURN    ${None}

Verify Book Exists In List
    [Documentation]    Verify book with specific title exists in list
    [Arguments]    ${books_list}    ${title}

    ${found}=    Find Book In List By Title    ${books_list}    ${title}
    Should Not Be Equal    ${found}    ${None}    msg=Book '${title}' not found in list

    Log    Verified book exists: ${title}
