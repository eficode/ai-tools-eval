*** Settings ***
Documentation     Common resource file with shared variables and keywords
...
...               This file contains application-wide configuration, shared variables,
...               and utility keywords used across all test suites.
...
...               Source: Generated by Claude Code following RF 7.4.1 standards

Library           Browser    timeout=10s    retry_assertions_for=1s
Library           RequestsLibrary
Library           Collections
Library           String
Library           DateTime
Library           OperatingSystem


*** Variables ***
# Application URLs
${BASE_URL}              http://books-service:8000
${UI_URL}                ${BASE_URL}
${API_BASE_URL}          ${BASE_URL}

# API Endpoints
${BOOKS_ENDPOINT}        /books/
${BOOK_BY_ID_ENDPOINT}   /books/{id}

# Timeouts
${SHORT_TIMEOUT}         3s
${MEDIUM_TIMEOUT}        10s
${LONG_TIMEOUT}          30s
${API_TIMEOUT}           10

# Browser Configuration
${BROWSER_TYPE}          chromium
${HEADLESS}              ${True}
${VIEWPORT_WIDTH}        1920
${VIEWPORT_HEIGHT}       1080

# Test Data Prefixes (to avoid conflicts with real data)
${TEST_PREFIX}           TEST_
${TEST_TIMESTAMP}        # Set dynamically in Suite Setup

# Common Selectors (UI)
${SEARCH_INPUT}          css=input[type="search"], input[placeholder*="Search"]
${SEARCH_BUTTON}         css=button:has-text("Search"), button[type="submit"]
${BOOK_CARD}             css=.book-card, .book-item, [data-testid="book-card"]
${LOADING_INDICATOR}     css=.loading, .spinner, [aria-busy="true"]

# HTTP Status Codes
${HTTP_OK}                     200
${HTTP_CREATED}                201
${HTTP_NO_CONTENT}             204
${HTTP_BAD_REQUEST}            400
${HTTP_NOT_FOUND}              404
${HTTP_UNPROCESSABLE_ENTITY}   422
${HTTP_SERVER_ERROR}           500


*** Keywords ***
Initialize Test Environment
    [Documentation]    Setup test environment for test suite
    ...                Creates unique timestamp for test data isolation
    ...                Initializes browser and API sessions

    ${timestamp}=    Get Time    epoch
    Set Suite Variable    ${TEST_TIMESTAMP}    ${timestamp}
    Log    Test suite started at: ${TEST_TIMESTAMP}

    # Initialize API session
    Create API Session

Cleanup Test Environment
    [Documentation]    Cleanup after test suite completion
    ...                Closes all browser contexts and API sessions

    TRY
        Close Browser    ALL
    EXCEPT
        Log    No browsers to close    level=DEBUG
    END

    Log    Test suite completed

Create API Session
    [Documentation]    Create RequestsLibrary session for API testing
    ...                Session is reusable across multiple requests

    VAR    &{headers}    Content-Type=application/json    Accept=application/json
    Create Session    books_api    ${API_BASE_URL}    headers=${headers}    timeout=${API_TIMEOUT}    verify=${True}

Generate Unique Test Data
    [Documentation]    Generate unique test data using timestamp and random string
    ...                Returns: Unique string suitable for test data
    [Arguments]    ${prefix}=${TEST_PREFIX}

    ${timestamp}=    Get Time    epoch
    ${random}=       Generate Random String    6    [LETTERS][NUMBERS]
    ${unique_id}=    Catenate    SEPARATOR=_    ${prefix}${timestamp}    ${random}

    RETURN    ${unique_id}

Initialize Browser Environment
    [Documentation]    Initialize browser with standard configuration
    ...                Creates browser, context, and opens new page

    New Browser    ${BROWSER_TYPE}    headless=${HEADLESS}
    VAR    &{viewport}    width=${VIEWPORT_WIDTH}    height=${VIEWPORT_HEIGHT}
    New Context    viewport=${viewport}

Wait For Page To Load
    [Documentation]    Wait for page to fully load
    ...                Uses multiple strategies to ensure page stability

    Wait For Load State    domcontentloaded    timeout=${MEDIUM_TIMEOUT}
    Wait For Load State    networkidle         timeout=${LONG_TIMEOUT}

Wait For Element To Be Ready
    [Documentation]    Wait for element to be visible and stable
    ...                Ensures element is interactable before returning
    [Arguments]    ${selector}    ${timeout}=${MEDIUM_TIMEOUT}

    Wait For Elements State    ${selector}    visible    timeout=${timeout}
    Wait For Elements State    ${selector}    stable     timeout=${timeout}

Verify Response Success
    [Documentation]    Verify API response has successful status code
    [Arguments]    ${response}    ${expected_status}=${HTTP_OK}

    Should Be Equal As Integers    ${response.status_code}    ${expected_status}
    ...    msg=Expected status ${expected_status} but got ${response.status_code}

Extract JSON Value
    [Documentation]    Safely extract value from JSON response
    ...                Returns: Value from JSON path or None if not found
    [Arguments]    ${response}    ${json_path}

    ${json_data}=    Set Variable    ${response.json()}
    ${value}=        Get Variable Value    ${json_data}${json_path}    ${None}

    RETURN    ${value}

Take Screenshot On Failure
    [Documentation]    Capture screenshot when test fails
    ...                Filename includes test name and timestamp

    ${timestamp}=    Get Time    epoch
    ${test_name}=    Set Variable    ${TEST_NAME}
    ${filename}=     Catenate    SEPARATOR=_    ${test_name}    ${timestamp}.png

    TRY
        Take Screenshot    filename=${filename}
        Log    Screenshot saved: ${filename}
    EXCEPT    AS    ${error}
        Log    Could not take screenshot: ${error}    level=WARN
    END

Log Request Details
    [Documentation]    Log HTTP request details for debugging
    [Arguments]    ${method}    ${endpoint}    ${data}=${None}

    Log    Request: ${method} ${endpoint}    level=INFO
    IF    ${data} is not ${None}
        Log    Request Data: ${data}    level=DEBUG
    END

Log Response Details
    [Documentation]    Log HTTP response details for debugging
    [Arguments]    ${response}

    Log    Response Status: ${response.status_code}    level=INFO
    Log    Response Body: ${response.text}              level=DEBUG
